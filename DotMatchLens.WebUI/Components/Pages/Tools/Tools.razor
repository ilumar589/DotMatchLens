@page "/tools"
@rendermode InteractiveServer
@inject PredictionsApiService PredictionsApi
@inject ISnackbar Snackbar

<PageTitle>Tools - DotMatchLens</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Agent Tools</MudText>

<MudGrid>
    <MudItem xs="12" md="6">
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Competition History Lookup</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudTextField @bind-Value="_competitionCode" Label="Competition Code" Variant="Variant.Outlined" 
                              Placeholder="e.g., PL, CL" />
                <MudButton OnClick="LookupCompetitionHistory" Variant="Variant.Filled" Color="Color.Primary" Class="mt-3">
                    Lookup
                </MudButton>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Find Similar Teams</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudTextField @bind-Value="_teamDescription" Label="Team Description" Variant="Variant.Outlined" 
                              Placeholder="e.g., strong attacking team" />
                <MudButton OnClick="FindSimilarTeams" Variant="Variant.Filled" Color="Color.Secondary" Class="mt-3">
                    Search
                </MudButton>
                @if (_similarTeams.Count > 0)
                {
                    <MudList T="string" Class="mt-3">
                        @foreach (var team in _similarTeams)
                        {
                            <MudListItem T="string">@team.Name (Score: @team.SimilarityScore.ToString("F2"))</MudListItem>
                        }
                    </MudList>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Search Competitions</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudTextField @bind-Value="_competitionQuery" Label="Search Query" Variant="Variant.Outlined" 
                              Placeholder="e.g., European leagues" />
                <MudButton OnClick="SearchCompetitions" Variant="Variant.Filled" Color="Color.Tertiary" Class="mt-3">
                    Search
                </MudButton>
                @if (_searchResults.Count > 0)
                {
                    <MudList T="string" Class="mt-3">
                        @foreach (var result in _searchResults)
                        {
                            <MudListItem T="string">@result.Name - @result.Code (Score: @result.SimilarityScore.ToString("F2"))</MudListItem>
                        }
                    </MudList>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Season Statistics</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudNumericField @bind-Value="_seasonId" Label="Season ID" Variant="Variant.Outlined" />
                <MudButton OnClick="GetSeasonStatistics" Variant="Variant.Filled" Color="Color.Info" Class="mt-3">
                    Get Statistics
                </MudButton>
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private string _competitionCode = "";
    private string _teamDescription = "";
    private string _competitionQuery = "";
    private int? _seasonId = null;
    
    private List<DotMatchLens.Predictions.Models.SimilarTeamResult> _similarTeams = [];
    private List<DotMatchLens.Predictions.Models.CompetitionSearchResult> _searchResults = [];

    private async Task LookupCompetitionHistory()
    {
        if (string.IsNullOrWhiteSpace(_competitionCode))
        {
            Snackbar.Add("Please enter a competition code", Severity.Warning);
            return;
        }

        try
        {
            var result = await PredictionsApi.GetCompetitionHistoryAsync(_competitionCode);
            if (result != null)
            {
                Snackbar.Add($"Competition: {result.Value.CompetitionName}, Seasons found: {result.Value.Seasons.Length}", Severity.Success);
            }
            else
            {
                Snackbar.Add("Competition not found", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task FindSimilarTeams()
    {
        if (string.IsNullOrWhiteSpace(_teamDescription))
        {
            Snackbar.Add("Please enter a description", Severity.Warning);
            return;
        }

        try
        {
            _similarTeams = await PredictionsApi.FindSimilarTeamsAsync(_teamDescription);
            Snackbar.Add($"Found {_similarTeams.Count} similar teams", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task SearchCompetitions()
    {
        if (string.IsNullOrWhiteSpace(_competitionQuery))
        {
            Snackbar.Add("Please enter a search query", Severity.Warning);
            return;
        }

        try
        {
            _searchResults = await PredictionsApi.SearchCompetitionsAsync(_competitionQuery);
            Snackbar.Add($"Found {_searchResults.Count} competitions", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task GetSeasonStatistics()
    {
        if (!_seasonId.HasValue)
        {
            Snackbar.Add("Please enter a season ID", Severity.Warning);
            return;
        }

        try
        {
            var result = await PredictionsApi.GetSeasonStatisticsAsync(_seasonId.Value);
            if (result != null)
            {
                Snackbar.Add($"Season: {result.Value.SeasonExternalId}, Matchdays: {result.Value.TotalMatchdays}", Severity.Success);
            }
            else
            {
                Snackbar.Add("Season not found", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }
}
